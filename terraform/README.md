# Master-Slave Architecture with Puppet and Nagios on AWS

This Terraform configuration deploys a complete master-slave architecture on AWS with:
- 1 Master Node (Puppet Master + Nagios Server)
- 2 Slave Nodes (Puppet Agents + NRPE for monitoring)

## Architecture Overview

### Master Node
- **Puppet Server**: Manages configuration of all slave nodes
- **Nagios Core**: Monitors CPU, memory, and disk usage of slave nodes
- **Instance Type**: t3.medium (2 vCPU, 4GB RAM)

### Slave Nodes
- **Puppet Agent**: Receives configuration from Puppet Master
- **NRPE**: Allows Nagios to monitor system metrics
- **Instance Type**: t3.small (2 vCPU, 2GB RAM)

## Monitoring Features

Nagios monitors the following on each slave node:
- **CPU Load**: Warns at 80%, Critical at 90%
- **Memory Usage**: Warns at 80%, Critical at 90%
- **Disk Usage**: Warns at 20% free, Critical at 10% free

## Prerequisites

1. **AWS Account** with appropriate permissions
2. **AWS CLI** installed and configured
3. **Terraform** installed (version >= 1.0)
4. **SSH Key Pair** - Can be auto-generated by Terraform or use existing

## Setup Instructions

### 1. Configure SSH Keys

**Option A: Let Terraform Create Keys (Easiest)**

No action needed! Terraform will automatically create a new key pair.
The private key will be saved to `terraform/private-key.pem`.

**Option B: Use Existing AWS Key Pair**

Edit `terraform.tfvars`:
```hcl
create_new_key = false
key_name = "your-existing-key-name"
```

### 2. Update Configuration (Optional)

Edit `terraform.tfvars` if you want to customize:

```hcl
aws_region = "us-east-1"                # Change if needed
master_instance_type = "t3.medium"      # Adjust as needed
slave_instance_type = "t3.small"        # Adjust as needed
slave_count = 2                         # Number of worker nodes
```

### 3. Initialize Terraform

```bash
cd terraform
terraform init
```

### 4. Review the Plan

```bash
terraform plan
```

### 5. Deploy Infrastructure

```bash
terraform apply
```

Type `yes` when prompted to confirm.

### 6. Get Access Information

After deployment, Terraform will output:

```
Outputs:

master_public_ip = "x.x.x.x"
nagios_url = "http://x.x.x.x/nagios"
private_key_path = "terraform/private-key.pem"
puppet_master_connection = "ssh -i private-key.pem ubuntu@x.x.x.x"
slave_public_ips = [
  "y.y.y.y",
  "z.z.z.z"
]
```

### 7. Secure Your Private Key

**IMPORTANT**: If Terraform generated the key, secure it immediately:

```powershell
# Set restrictive permissions
icacls terraform\private-key.pem /inheritance:r
icacls terraform\private-key.pem /grant:r "$($env:USERNAME):(R)"

# Move to secure location (optional)
Move-Item terraform\private-key.pem ~\.ssh\infrastructure-key.pem
```

## Accessing Services

### Nagios Web Interface

1. Open browser and go to: `http://<master_public_ip>/nagios`
2. Login credentials:
   - Username: `nagiosadmin`
   - Password: `nagiosadmin`

**IMPORTANT**: Change the default password after first login!

### SSH Access

Connect to master:
```bash
ssh -i private-key.pem ubuntu@<master_public_ip>
```

Connect to slaves:
```bash
ssh -i private-key.pem ubuntu@<slave_public_ip>
```

**Note:** If you moved the key to `~/.ssh/`, adjust the path accordingly.

## Puppet Management

### On Master Node

View certificate requests:
```bash
sudo /opt/puppetlabs/bin/puppetserver ca list
```

Sign a certificate:
```bash
sudo /opt/puppetlabs/bin/puppetserver ca sign --certname slave-1
```

Sign all certificates:
```bash
sudo /opt/puppetlabs/bin/puppetserver ca sign --all
```

### On Slave Nodes

Run Puppet agent manually:
```bash
sudo /opt/puppetlabs/bin/puppet agent --test
```

Check Puppet agent status:
```bash
sudo systemctl status puppet
```

## Nagios Monitoring

### View Monitoring Status

1. Login to Nagios web interface
2. Navigate to **Services** â†’ **Service Problems**
3. View CPU, Memory, and Disk metrics for all slaves

### Test NRPE Manually

From master node:
```bash
/usr/local/nagios/libexec/check_nrpe -H <slave_ip> -c check_load
/usr/local/nagios/libexec/check_nrpe -H <slave_ip> -c check_mem
/usr/local/nagios/libexec/check_nrpe -H <slave_ip> -c check_disk
```

## Configuration Files

### Puppet Manifest Location
- Master: `/etc/puppetlabs/code/environments/production/manifests/site.pp`

### Nagios Configuration
- Main config: `/usr/local/nagios/etc/nagios.cfg`
- Slave definitions: `/usr/local/nagios/etc/objects/slaves.cfg`
- Commands: `/usr/local/nagios/etc/objects/commands.cfg`

### NRPE Configuration
- Slaves: `/etc/nagios/nrpe.cfg`

## Customization

### Add More Slaves

Edit `terraform.tfvars`:
```hcl
slave_count = 3  # or any number you need
```

Then run:
```bash
terraform apply
```

### Modify Monitoring Thresholds

Edit the NRPE commands in `/etc/nagios/nrpe.cfg` on slave nodes:

```bash
# CPU Load: -w (warning) -c (critical)
command[check_load]=/usr/lib/nagios/plugins/check_load -w 15,10,5 -c 30,25,20

# Disk: -w (warning %) -c (critical %)
command[check_disk]=/usr/lib/nagios/plugins/check_disk -w 20% -c 10% -p /
```

## Troubleshooting

### Puppet Issues

Check Puppet server status:
```bash
sudo systemctl status puppetserver
```

View Puppet server logs:
```bash
sudo journalctl -u puppetserver -f
```

### Nagios Issues

Check Nagios status:
```bash
sudo systemctl status nagios
```

Verify Nagios configuration:
```bash
sudo /usr/local/nagios/bin/nagios -v /usr/local/nagios/etc/nagios.cfg
```

Restart Nagios:
```bash
sudo systemctl restart nagios
```

### NRPE Issues

Check NRPE status on slaves:
```bash
sudo systemctl status nagios-nrpe-server
```

Test NRPE locally on slave:
```bash
/usr/lib/nagios/plugins/check_nrpe -H localhost -c check_load
```

## Security Considerations

**ðŸ”’ READ THE SECURITY GUIDE:** See [SECURITY.md](SECURITY.md) for complete security instructions!

1. **Secure your private key immediately after deployment**

2. **Change default passwords**:
   ```bash
   sudo htpasswd /usr/local/nagios/etc/htpasswd.users nagiosadmin
   ```

3. **Restrict SSH access**: Update security groups to allow SSH only from your IP:
   ```powershell
   # Get your IP
   (Invoke-WebRequest -Uri "https://api.ipify.org").Content
   
   # Update terraform/main.tf with your IP in the master security group
   ```
   
4. **Enable HTTPS**: Configure SSL certificates for Nagios web interface

5. **Never commit private keys**: The `.gitignore` file is configured to prevent this

6. **Consider AWS Systems Manager Session Manager**: For keyless access to instances

## Cost Estimation

Approximate monthly costs (us-east-1):
- 1 x t3.medium: ~$30/month
- 2 x t3.small: ~$30/month
- Total: ~$60/month (excluding data transfer)

## Cleanup

To destroy all resources:

```bash
terraform destroy
```

Type `yes` when prompted.

## Files Structure

```
terraform/
â”œâ”€â”€ main.tf              # Main infrastructure configuration
â”œâ”€â”€ variables.tf         # Variable definitions
â”œâ”€â”€ outputs.tf           # Output definitions
â”œâ”€â”€ terraform.tfvars     # Variable values (customize this!)
â”œâ”€â”€ key_pair.tf          # SSH key pair management
â”œâ”€â”€ .gitignore           # Prevents committing sensitive files
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ master_init.sh   # Master node initialization
â”‚   â””â”€â”€ slave_init.sh    # Slave node initialization
â”œâ”€â”€ puppet/
â”‚   â”œâ”€â”€ site.pp          # Puppet manifest
â”‚   â””â”€â”€ nrpe.cfg.erb     # NRPE configuration template
â”œâ”€â”€ README.md            # This file
â”œâ”€â”€ SECURITY.md          # Security best practices (READ THIS!)
â””â”€â”€ ARCHITECTURE.md      # Architecture documentation
```

## Support

For issues related to:
- **Terraform**: Check [Terraform Documentation](https://www.terraform.io/docs)
- **Puppet**: Check [Puppet Documentation](https://puppet.com/docs)
- **Nagios**: Check [Nagios Documentation](https://www.nagios.org/documentation/)

## License

This configuration is provided as-is for educational and development purposes.
